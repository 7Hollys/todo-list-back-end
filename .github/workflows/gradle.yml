
name: todo-backend-cicd

on:
  push:
    branches: [ todo-ci-test ]
#   pull_request:
#     branches: [ master ]
env:
  PROJECT_NAME: todo-list-back-end
  BUCKET: github-action-todo
  JAR_NAME: todoList-0.0.1-SNAPSHOT
  ZIP_NAME: todo
  
jobs:
  build:

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2
    - name: Set up JDK 1.8
      uses: actions/setup-java@v1
      with:
        java-version: 1.8
      
    - name: Grant execute permission for gradlew
      run: chmod +x gradlew
    - name: application.yml add
      run: |
       vi src/main/resources/application.yml
       '${{ secrets.APPLICATION }}'
       
    - name: file com
      run: |
       cd src/main/resources/
       ls -al

    - name: Build with Gradle
      run: gradle bootjar
      
    - name: MAKE DEPLOYMENT DIR
      run: mkdir -p code-deploy-${PROJECT_NAME}
    - name: MOVE JAR
      run: cp build/libs/${JAR_NAME}.jar code-deploy-${PROJECT_NAME}/
    - name: CD JAR FOLDER AND ZIP CODE DEPLOY
      run: |
       cd code-deploy-${PROJECT_NAME}
       zip ${ZIP_NAME}.zip ${JAR_NAME}.jar
      
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v1
      with:
        aws-access-key-id: '${{ secrets.AWS_ACCESS_KEY_ID }}'
        aws-secret-access-key: '${{ secrets.AWS_SECRET_ACCESS_KEY }}'
        aws-region: ap-northeast-2

    - name: Upload to S3
      run: aws s3 cp code-deploy-${PROJECT_NAME}/${ZIP_NAME}.zip s3://${BUCKET}/jar/ --region ap-northeast-2
 
      
